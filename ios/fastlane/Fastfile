default_platform(:ios)

platform :ios do
  desc "Setup CI environment (keychain, pods, clean)"
  lane :setup_ci do
    # Nettoyage des artefacts de build
    sh("rm -rf ./build")
    # Installation des pods
    sh("pod install")
    # Configuration du keychain pour la CI
    setup_ci_keychain(
      keychain_name: "login",
      keychain_password: ENV["KEYCHAIN_PASSWORD"] || "password"
    )
  end

  desc "Build and archive iOS app"
  lane :build do
    setup_ci if is_ci
    
    # Debug: List files in current directory
    sh("ls -la")
    
    # Build the app with manual xcodebuild commands
    sh("xcodebuild -workspace ./Runner.xcworkspace -scheme Runner -configuration Release -archivePath ./build/Runner.xcarchive clean archive -allowProvisioningUpdates -sdk iphoneos -destination 'generic/platform=iOS' -allowProvisioningDeviceRegistration")
    
    # Export the archive
    sh("xcodebuild -exportArchive -archivePath ./build/Runner.xcarchive -exportOptionsPlist ./exportOptions.plist -exportPath ./build/ios -allowProvisioningUpdates")
  end

  desc "Upload to App Store Connect"
  lane :upload do
    # Remplace le chemin IPA si besoin
    upload_to_app_store(
      ipa: "./build/ios/SmoothAI.ipa"
    )
  end

  desc "Build and upload to App Store Connect"
  lane :build_and_upload do
    build
    upload
  end

  desc "Debug code signing setup"
  lane :debug_signing do
    # Affiche les certificats install√©s
    sh("security find-identity -v -p codesigning")
    # Affiche les profils de provisioning
    sh("ls -l ~/Library/MobileDevice/Provisioning\ Profiles/")
    # Affiche les variables d'environnement utiles
    sh("env | grep -E 'APPLE|MATCH|FASTLANE|KEYCHAIN'")
  end
end